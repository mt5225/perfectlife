perfect = perfect or {}

xml2js = require('xml2js')

perfect.Message = do ->
  Message = ->

  ################
  #message Temples
  ################
  msgTemple = (fromId, toId, msg) ->
    "
    <xml>
    <ToUserName><![CDATA[#{fromId}]]></ToUserName>
    <FromUserName><![CDATA[#{toId}]]></FromUserName>
    <CreateTime>12345678</CreateTime>
    <MsgType><![CDATA[text]]></MsgType>
    <Content><![CDATA[#{msg}]]></Content>
    </xml>
    "

  msgArticleTemple = (fromId, toId, msg) ->
    "
    <xml>
    <ToUserName><![CDATA[#{fromId}]]></ToUserName>
    <FromUserName><![CDATA[#{toId}]]></FromUserName>
    <CreateTime>12345678</CreateTime>
    <MsgType><![CDATA[news]]></MsgType>
    <ArticleCount>1</ArticleCount>
    <Articles>
    <item>
    <Title><![CDATA[#{msg.title}]]></Title>
    <Description><![CDATA[#{msg.description}]]></Description>
    <PicUrl><![CDATA[#{msg.picurl}]]></PicUrl>
    <Url><![CDATA[#{msg.url}]]></Url>
    </item>
    </Articles>
    </xml>
    "

  # V1001_PING : under construction
  defaultMsg = """
  功能建设中 ...
  """

  # V1002_AGH: show AGH Menu
  aghMsg = """
  请回复数字选取您兴趣的部落:
  [1] 芦茨土屋
  [2] 石舍香樟
  [3] 玫瑰庄园
  """

  #Message if user input is invalid
  errMsg = "%^&%^&$^("

  #Message Map for event
  EventMsgMap = {
    'V1002_AGH': aghMsg
  }

  #Message Map to text
  ArticleMsgMap =
    'V1002_AGH_1':
      title : '芦茨土屋'
      description : '自然、回归、原生态，则是芦茨土屋坚守不变的色彩 ... 依自然而建，无论原木的外表，还是屋内的树木，家园的每一处都保持了自然有机的风格, 每一处陈设，每一处设计，每一个遐想，每一个憧憬，主角可以是你，配角也可以是你'
      picurl : 'http://119.29.114.143:9000/static/images/lztw.jpg'
      url: 'http://119.29.114.143:9000'
    'V1002_AGH_2':
      title : '石舍香樟'
      description : '那株久远到无法考证年代的香樟树，那湾清澈可见底的涓涓溪水，那抹夜色中的草长莺飞衍生野趣...... 石舍香樟 完美生活的见证。'
      picurl : 'http://119.29.114.143:9000/static/images/ssxz.jpg'
      url: 'http://119.29.114.143:9000'



  Message.geMessageByEvent = (eventKey, fromId, toId) ->
    msgTemple fromId,toId, (EventMsgMap[eventKey] || defaultMsg)


  Message.getMessageByText = (msgText, fromId, toId, session) ->
    msgKey = ""
    try
      msgKey = "#{session.status}_#{msgText}"
      console.log "message key:  #{msgKey}"
    catch error
      console.log "session is empty, user input without select a menu"

    msgArticleTemple fromId,toId, (ArticleMsgMap[msgKey] || errMsg)

  Message.defaultMessage = (fromId, toId) ->
    msgTemple fromId, toId, errMsg

  Message

exports.message = perfect.Message
